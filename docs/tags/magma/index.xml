<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Magma on MatLoverによるMatlab以外のブログ</title>
    <link>http://localhost:1313/mblog/tags/magma/</link>
    <description>Recent content in Magma on MatLoverによるMatlab以外のブログ</description>
    <generator>Hugo</generator>
    <language>ja</language>
    <lastBuildDate>Mon, 12 Jun 2023 00:00:00 +0000</lastBuildDate>
    <atom:link href="http://localhost:1313/mblog/tags/magma/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>magma-nvimで理想に近いVimでのJupyter環境を作る</title>
      <link>http://localhost:1313/mblog/posts/magma-nvim%E3%81%A7%E7%90%86%E6%83%B3%E3%81%AB%E8%BF%91%E3%81%84vim%E3%81%A7%E3%81%AEjupyter%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B/</link>
      <pubDate>Mon, 12 Jun 2023 00:00:00 +0000</pubDate>
      <guid>http://localhost:1313/mblog/posts/magma-nvim%E3%81%A7%E7%90%86%E6%83%B3%E3%81%AB%E8%BF%91%E3%81%84vim%E3%81%A7%E3%81%AEjupyter%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B/</guid>
      <description>&lt;p&gt;vimで開発しているとブラウザからJupyterを触るのが嫌になってきます。&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;開発中にターミナルとブラウザへ移動が面倒&lt;/li&gt;&#xA;&lt;li&gt;vimで使っているformatterとかlinterをそのまま使いたい&lt;/li&gt;&#xA;&lt;li&gt;Jupyter上でもvimキーバインドを設定しているけど、ブラウザのキーバインドと被る&lt;/li&gt;&#xA;&lt;li&gt;vimからIPython上に実行結果を表示する方法もあるが、残念ながらめんどくさかったりで運用面があわない&lt;/li&gt;&#xA;&lt;li&gt;PyCharmやVSCodeを使えばいいじゃんという声が聞こえてきますが、とりあえずPyCharmは気になるところが多くて疲れました&amp;hellip;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;前々からvimで完結するようにしたいなぁと思っていたのですが、ようやくそれがある程度実現されてきたので紹介していきます。&lt;/p&gt;&#xA;&lt;h2 id=&#34;magma-nvim&#34;&gt;magma-nvim&lt;/h2&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://github.com/dccsillag/magma-nvim&#34;&gt;magma-nvim&lt;/a&gt;はJupyterカーネルに選択したコードの実行をさせて、結果をvim上に表示するためのプラグインです。&lt;br&gt;&#xA;上記のリンク先にデモ動画が載っていますが、自分が用意したものを載せておきます。&#xA;&lt;video controls preload=&#34;auto&#34; width=&#34;100%&#34;  playsinline class=&#34;html-video&#34;&gt;&#xA;    &lt;source src=&#34;http://localhost:1313/mblog/posts/magma-nvim%E3%81%A7%E7%90%86%E6%83%B3%E3%81%AB%E8%BF%91%E3%81%84vim%E3%81%A7%E3%81%AEjupyter%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B/magma-sample.webm&#34; type=&#34;video/webm&#34;&gt;&#xA;  &lt;span&gt;お使いのブラウザは埋め込み動画をサポートしていませんが、&lt;a href=&#34;http://localhost:1313/mblog/posts/magma-nvim%E3%81%A7%E7%90%86%E6%83%B3%E3%81%AB%E8%BF%91%E3%81%84vim%E3%81%A7%E3%81%AEjupyter%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B/magma-sample.webm&#34;&gt;ダウンロード&lt;/a&gt; して、お好きなメディアプレーヤーで再生できます。&lt;/span&gt;&#xA;&lt;/video&gt;&lt;/p&gt;&#xA;&lt;p&gt;これが本当に素晴らしくよくできています。magma-nvimの存在を知ったときはテンション爆あがりでした。&lt;/p&gt;&#xA;&lt;p&gt;が、自分の運用上はだいぶ困った点がありました。&lt;/p&gt;&#xA;&lt;p&gt;というのも、magma-nvimでは:MagmaInitで用意したJupyterのカーネルを選択することができますが、基本的にはホスト上にあるカーネルを選択することになります。&lt;br&gt;&#xA;自分の場合は、案件ごとにJupyter labのサーバーをDockerコンテナ内に立てるようにしていますので、ここが噛み合わないのです。&lt;br&gt;&#xA;Docker内のカーネルをホストのJupyterに追加できるらしい方法はいくつか試したのですが、うまくいかず…。&lt;/p&gt;&#xA;&lt;h3 id=&#34;カーネル選択の問題の解決&#34;&gt;カーネル選択の問題の解決&lt;/h3&gt;&#xA;&lt;p&gt;magma-nvimのコードを眺めていると、Jupyter Clientとかいう謎のライブラリを使ってカーネルを操作していることがわかりました。&lt;br&gt;&#xA;じゃあJupyter ClientでDockerコンテナ上で動いているカーネルを触りにいけばいいじゃないとなるのですが、無理っぽい雰囲気です。おそらく。正直このあたり何も知らないのでよく分かりませんが。&lt;/p&gt;&#xA;&lt;p&gt;苦渋の選択ですが、サーバー上のJupyterカーネルを触るためのAPIが存在しますので、こちらを使ってうまく既存のmagma-nvimと連携させようという方向性になりました。&lt;br&gt;&#xA;非常に重い腰をあげて、それっぽく動くところまで実装したのがこちらになります。&#xA;&lt;a href=&#34;https://github.com/opqrstuvcut/magma-nvim&#34;&gt;https://github.com/opqrstuvcut/magma-nvim&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;これを使うと、&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;:MagmaInit http://localhost:8080/?token=5fe4e1d52e7b0fc72986a7683b8d7a71f804b92fee991b7e&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;みたいな感じでJupyterサーバーへのURLをMagmaInitに渡すことで、サーバー上のカーネルを実行できるようになります。&lt;br&gt;&#xA;自分の実装が悪いのか、セルの実行をしたときにもっさりしているような…？&lt;/p&gt;&#xA;&lt;p&gt;ちなみにJupyterのAPIを扱う部分の実装には下記のブログ記事をかなり参考にさせていただきました。ありがとうございます。&lt;br&gt;&#xA;&lt;a href=&#34;https://ohke.hateblo.jp/entry/2019/05/25/180000&#34;&gt;https://ohke.hateblo.jp/entry/2019/05/25/180000&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h3 id=&#34;magma-nvimを使う時の注意&#34;&gt;magma-nvimを使う時の注意&lt;/h3&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;最近はmagma-nvimの開発がおこなわれていないようです。とりあえずmagma-nvimを使ってみたい方は&lt;a href=&#34;https://github.com/WhiteBlackGoose/magma-nvim-goose&#34;&gt;https://github.com/WhiteBlackGoose/magma-nvim-goose&lt;/a&gt;を利用するとバグが直っていたり、機能が追加されていたりするので良いかと思います。&lt;/li&gt;&#xA;&lt;li&gt;画像の表示がうまくいかないケースが報告されています。自分の環境でも画像が表示されたり、されなかったり不思議な現象がおきています。これはなんとかしたいですが、magma-nvimを使わない理由とまではいきません。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;便利にするためのkeymap&#34;&gt;便利にするためのkeymap&lt;/h2&gt;&#xA;&lt;p&gt;Notebookを編集するときには&lt;a href=&#34;https://github.com/goerz/jupytext.vim&#34;&gt;https://github.com/goerz/jupytext.vim&lt;/a&gt;によって、いい感じにNotebookの内容をフォーマットして表示しています。&lt;br&gt;&#xA;これと以下のようなkermapを組み合わせてNotebookを編集しています。&lt;/p&gt;&#xA;&lt;h3 id=&#34;セルの実行&#34;&gt;セルの実行&lt;/h3&gt;&#xA;&lt;p&gt;magma-nvimだと、例えばvisual modeで複数行を選択し、:MagmaEvaluateVisualを実行することでセルが定義されます（Notebook上のセルとは違う話です）。一度セルを定義すれば、その後はvisual modeで行選択をしなくてもセル単位で実行することができます。&lt;/p&gt;&#xA;&lt;p&gt;なのですが、やはりめんどうなのと、jupytextを使えば実際のNotebook上のセルを# %%で挟んで表示してくれますので、# %%で囲まれたコード単位で実行したくなります。&lt;br&gt;&#xA;これは次のMagmaEvaluateCellを定義して実現しています（luaやvimのapiの使い方のセオリーがわからないので変だったらすみません）。&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;function FindNextLineWithText(pattern)&#xA;    local currentLine = vim.fn.line(&amp;#39;.&amp;#39;)&#xA;    local totalLines = vim.fn.line(&amp;#39;$&amp;#39;)&#xA;&#xA;    for line = currentLine + 1, totalLines do&#xA;        local lineText = vim.api.nvim_buf_get_lines(0, line - 1, line, false)[1]&#xA;        if lineText:find(pattern) then&#xA;            return line&#xA;        end&#xA;    end&#xA;&#xA;    return totalLines&#xA;end&#xA;&#xA;function FindPrevLineWithText(pattern, start_buffer)&#xA;    start_buffer = start_buffer or 0&#xA;    local currentLine = vim.fn.line(&amp;#39;.&amp;#39;)&#xA;&#xA;    for line = currentLine + start_buffer , 1, -1 do&#xA;        local lineText = vim.api.nvim_buf_get_lines(0, line - 1, line, false)[1]&#xA;        if lineText:find(pattern) then&#xA;            return line&#xA;        end&#xA;    end&#xA;&#xA;    return 0&#xA;end&#xA;&#xA;function MagmaEvaluateCell()&#xA;    local pattern = &amp;#34;# %%&amp;#34;&#xA;    local startLine = FindPrevLineWithText(pattern)&#xA;    local endLine = FindNextLineWithText(pattern)&#xA;&#xA;    vim.api.nvim_win_set_cursor(0, { startLine + 1, 0 })&#xA;    vim.api.nvim_feedkeys(&amp;#39;V&amp;#39;..(endLine-1)..&amp;#39;gg&amp;#39;, &amp;#39;n&amp;#39;, true)&#xA;    vim.api.nvim_feedkeys(vim.api.nvim_replace_termcodes(&amp;#39;:&amp;lt;C-u&amp;gt;MagmaEvaluateVisual&amp;lt;CR&amp;gt;&amp;#39;, true, true, true), &amp;#39;n&amp;#39;, true)&#xA;end&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;載せているデモ動画ではMagmaEvaluateCellを&amp;quot;mc&amp;quot;に設定しており、実行したいセル上にカーソルをもっていって利用しています。&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
